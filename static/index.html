<!doctype html>
<title>Todo app</title>
<script src="//cdnjs.cloudflare.com/ajax/libs/mithril/0.2.5/mithril.min.js"></script>
<body>
<script>

var todo = {};

todo.Todo = function(data) {
    this.id = m.prop(data.id);
    this.description = m.prop(data.description);
    this.done = m.prop(data.done);
    this.check = function() {
        var data = new FormData();
        data.append("id", this.id());
        data.append("done", !this.done());
        m.request({
            method: "PUT", 
            url: "/tasks",
            data: data,
            serialize: function(data) {return data}
        })
    }
};

todo.TodoList = Array;

todo.vm = (function() {
    var vm = {}
    vm.init = function() {
        vm.list = new todo.TodoList();

        vm.description = m.prop("");

        vm.add = function() {
            if (vm.description()) {
                var id = vm.list.length
                vm.list.push(new todo.Todo({id: id, description: vm.description(), done: false}));
                var data = new FormData();
                data.append("id", id);
                data.append("description", vm.description());
                vm.description("");
                m.request({
                    method: "POST",
                    url: "/tasks",
                    data: data,
                    serialize: function(data) {return data}
                })
            }
        };

        m.request({method: "GET", url: "/tasks"}).then(function(data) {
            var tasks = data.tasks
            for (var i in tasks) {
                vm.list.push(new todo.Todo({id: tasks[i].id, description: tasks[i].description, done: tasks[i].done}));
            }
        });        
    }
    return vm
}())

todo.controller = function() {
    todo.vm.init();
}

todo.view = function() {
    return [
        m("input", {onchange: m.withAttr("value", todo.vm.description), value: todo.vm.description()}),
        m("button", {onclick: todo.vm.add}, "Add"),
        m("table", [
            todo.vm.list.map(function(task, index) {
                return m("tr", [
                    m("td", [
                        m("input[type=checkbox]", {onClick: task.check(), checked: task.done()})
                    ]),
                    m("td", {style: {textDecoration: task.done() ? "line-through" : "none"}}, task.description()),
                ])
            })
        ])
    ]
};

m.mount(document.body, {controller: todo.controller, view: todo.view});
</script>
</body>